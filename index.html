<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thinkt Lite</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/i18n.js"></script>
</head>

<body>
    <div class="top-bar">
        <div class="connection-status" id="connection-status" onclick="pingServer()" title="Click to check connection">
            <span class="status-dot"></span>
            <span class="status-text">Connecting...</span>
        </div>
        <div class="top-bar-row">
            <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle light/dark mode">
                <span class="theme-icon">üåô</span>
            </button>
            <div class="lang-selector" id="lang-selector">
                <button class="lang-toggle" onclick="toggleLangMenu()">
                    <span class="lang-current">EN</span>
                    <span class="lang-caret">‚ñº</span>
                </button>
                <div class="lang-menu" id="lang-menu"></div>
            </div>
        </div>
    </div>

    <div class="nav">
        <h3><code data-i18n="app-title">thinkt lite</code></h3>
        <a href="/swagger/" class="primary" data-i18n="api-docs">thinkt API Docs</a>
        <button onclick="showApiModal('Sources', '/api/v1/sources')" data-i18n="api-sources">API: Sources</button>
        <button onclick="showApiModal('Projects', '/api/v1/projects')" data-i18n="api-projects">API: Projects</button>
        <button onclick="showApiModal('Apps', '/api/v1/open-in/apps')" data-i18n="api-apps">API: Apps</button>
        <button onclick="showApiModal('Themes', '/api/v1/themes')" data-i18n="api-themes">API: Themes</button>
    </div>

    <div class="content">
        <div class="left-column">
            <div class="panel">
                <h2><span class="icon">üì¶</span> <span data-i18n="sources">Sources</span></h2>
                <div id="sources-list" class="loading" data-i18n="loading">Loading...</div>
            </div>

            <div class="panel">
                <h2><span class="icon">üöÄ</span> <span data-i18n="apps">Apps</span></h2>
                <div id="apps-list" class="loading" data-i18n="loading">Loading...</div>
            </div>

            <div class="panel">
                <h2><span class="icon">üé®</span> <span data-i18n="themes">Themes</span></h2>
                <div id="themes-list" class="loading" data-i18n="loading">Loading...</div>
            </div>
        </div>

        <div class="panel projects-panel">
            <h2><span class="icon">üìÅ</span> <span data-i18n="projects">Projects</span> <span id="project-count"
                    class="badge">-</span></h2>
            <div id="projects-list" class="project-list loading" data-i18n="loading">Loading...</div>
        </div>
    </div>

    <!-- API Response Modal -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title" id="modal-title" data-i18n="api-response">API Response</span>
                <div class="modal-actions">
                    <a id="modal-raw-link" href="#" target="_blank" data-i18n="view-raw">View Raw</a>
                    <button onclick="copyUrl()" data-i18n="copy-url">Copy URL</button>
                    <button class="close-btn" onclick="closeModal()" data-i18n="close">Close</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="json-view" id="modal-content"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';

        // Track visible sources (all visible by default)
        const visibleSources = new Set();

        // Store available apps for open-in
        let availableApps = [];

        async function showApiModal(title, endpoint) {
            const overlay = document.getElementById('modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const rawLink = document.getElementById('modal-raw-link');

            const url = `${API_BASE}${endpoint}`;
            modalTitle.textContent = `API: ${title}`;
            rawLink.href = url;
            modalContent.innerHTML = `<span class="loading">${t('loading')}</span>`;
            overlay.classList.add('active');

            try {
                const res = await fetch(url);
                const data = await res.json();
                modalContent.innerHTML = syntaxHighlight(JSON.stringify(data, null, 2));
            } catch (e) {
                modalContent.innerHTML = `<span class="error">${t('error')}: ${escapeHtml(e.message)}</span>`;
            }
        }

        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modal-overlay').classList.remove('active');
        }

        function copyUrl() {
            const url = document.getElementById('modal-raw-link').href;
            navigator.clipboard.writeText(url).then(() => {
                const btn = event.target;
                const original = btn.textContent;
                btn.textContent = t('copied');
                setTimeout(() => btn.textContent = original, 1500);
            }).catch(() => { });
        }

        function syntaxHighlight(json) {
            json = escapeHtml(json);
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        async function loadSources() {
            const container = document.getElementById('sources-list');
            try {
                const res = await fetch(`${API_BASE}/api/v1/sources`);
                const data = await res.json();

                if (!data.sources || data.sources.length === 0) {
                    container.innerHTML = `<div class="empty-state">${t('no-sources')}</div>`;
                    return;
                }

                // Initialize all sources as visible
                data.sources.forEach(s => visibleSources.add(s.name));

                container.innerHTML = data.sources.map(s => `
                    <div class="source-item source-${s.name.toLowerCase()}">
                        <div>
                            <div class="source-name">${escapeHtml(s.name)}</div>
                            ${s.base_path ? `<div class="source-meta">${escapeHtml(truncatePath(s.base_path))}</div>` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span class="source-visibility" data-source="${escapeHtml(s.name)}" onclick="toggleSourceVisibility('${escapeHtml(s.name)}')" title="${t('toggle-visibility')}">
                                üëÅÔ∏è
                            </span>
                            <span class="source-status ${s.available ? 'available' : 'unavailable'}">
                                ${s.available ? t('ok') : t('na')}
                            </span>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = `<div class="error">${t('error')}: ${escapeHtml(e.message)}</div>`;
            }
        }

        async function loadApps() {
            const container = document.getElementById('apps-list');
            try {
                const res = await fetch(`${API_BASE}/api/v1/open-in/apps`);
                const data = await res.json();

                // Store apps globally for use in project list
                availableApps = data.apps || [];

                if (availableApps.length === 0) {
                    container.innerHTML = `<div class="empty-state">${t('no-apps')}</div>`;
                    return;
                }

                container.innerHTML = availableApps.map(app => `
                    <div class="app-item">
                        <div>
                            <div class="app-name">${escapeHtml(app.name)}</div>
                            <div class="app-meta">${escapeHtml(app.id)}</div>
                        </div>
                        <span class="app-status enabled">${t('ready')}</span>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = `<div class="error">${t('error')}: ${escapeHtml(e.message)}</div>`;
            }
        }

        async function openInApp(appId, path) {
            try {
                const res = await fetch(`${API_BASE}/api/v1/open-in`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ app: appId, path: path })
                });
                const data = await res.json();
                if (!res.ok) {
                    console.error('Failed to open:', data);
                }
            } catch (e) {
                console.error('Error opening app:', e);
            }
        }

        function renderOpenInDropdown(path) {
            if (availableApps.length === 0) return '';

            const defaultApp = availableApps[0];
            const otherApps = availableApps.slice(1);
            const dropdownId = `dropdown-${path.replace(/[^a-zA-Z0-9]/g, '-')}`;

            return `
                <div class="open-in-dropdown">
                    <button class="open-in-default" onclick="event.stopPropagation(); openInApp('${escapeHtml(defaultApp.id)}', '${escapeHtml(path)}')" title="${escapeHtml(defaultApp.name)}">
                        ${escapeHtml(defaultApp.name.split(' ')[0])}
                    </button>
                    ${otherApps.length > 0 ? `
                        <button class="open-in-toggle" onclick="event.stopPropagation(); toggleOpenInMenu('${dropdownId}')" title="More options">
                            ‚ñº
                        </button>
                        <div class="open-in-menu" id="${dropdownId}">
                            ${otherApps.map(app => `
                                <button class="open-in-menu-item" onclick="event.stopPropagation(); openInApp('${escapeHtml(app.id)}', '${escapeHtml(path)}'); hideOpenInMenu('${dropdownId}')">
                                    ${escapeHtml(app.name)}
                                </button>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function toggleOpenInMenu(menuId) {
            // Hide all other menus first
            document.querySelectorAll('.open-in-menu').forEach(menu => {
                if (menu.id !== menuId) menu.classList.remove('show');
            });
            const menu = document.getElementById(menuId);
            if (menu) menu.classList.toggle('show');
        }

        function hideOpenInMenu(menuId) {
            const menu = document.getElementById(menuId);
            if (menu) menu.classList.remove('show');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.open-in-dropdown')) {
                document.querySelectorAll('.open-in-menu').forEach(menu => menu.classList.remove('show'));
            }
        });

        async function loadThemes() {
            const container = document.getElementById('themes-list');
            try {
                const res = await fetch(`${API_BASE}/api/v1/themes`);
                const data = await res.json();

                if (!data.themes || data.themes.length === 0) {
                    container.innerHTML = `<div class="empty-state">${t('no-themes')}</div>`;
                    return;
                }

                container.innerHTML = data.themes.map(theme => `
                    <div class="theme-item ${theme.active ? 'active' : ''}">
                        <div>
                            <div class="theme-name">${escapeHtml(theme.name)}${theme.active ? ` <span class="theme-badge">${t('active')}</span>` : ''}</div>
                            <div class="theme-meta">${escapeHtml(theme.description || (theme.embedded ? t('built-in-theme') : t('user-theme')))}</div>
                        </div>
                        <span class="theme-type">${theme.embedded ? t('built-in') : t('user')}</span>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = `<div class="error">${t('error')}: ${escapeHtml(e.message)}</div>`;
            }
        }

        // Detect home directory prefix
        function detectHomeDir(projects) {
            if (!projects || projects.length === 0) return null;
            // Look for common home directory patterns
            const homePrefixes = ['/Users/', '/home/', 'C:\\Users\\'];
            for (const p of projects) {
                for (const prefix of homePrefixes) {
                    const idx = p.path.indexOf(prefix);
                    if (idx !== -1) {
                        // Extract full home dir (e.g., /Users/evan or /home/user)
                        const afterPrefix = p.path.slice(idx + prefix.length);
                        const nextSlash = afterPrefix.indexOf('/');
                        const nextBackslash = afterPrefix.indexOf('\\');
                        let endIdx = -1;
                        if (nextSlash !== -1 && nextBackslash !== -1) {
                            endIdx = Math.min(nextSlash, nextBackslash);
                        } else if (nextSlash !== -1) {
                            endIdx = nextSlash;
                        } else if (nextBackslash !== -1) {
                            endIdx = nextBackslash;
                        }
                        if (endIdx !== -1) {
                            return p.path.slice(0, idx + prefix.length + endIdx);
                        }
                    }
                }
            }
            return null;
        }

        // Format path with dimmed home directory
        function formatPathWithDim(path, homeDir) {
            if (!homeDir || !path.startsWith(homeDir)) {
                return `<span class="path-highlight">${escapeHtml(path)}</span>`;
            }
            const dimPart = path.slice(0, homeDir.length);
            const highlightPart = path.slice(homeDir.length);
            return `<span class="path-dim">${escapeHtml(dimPart)}</span><span class="path-highlight">${escapeHtml(highlightPart)}</span>`;
        }

        // Render source badges
        function renderSourceBadges(sources) {
            return sources.map(s => {
                const sourceClass = `source-${s.name.toLowerCase()}`;
                return `<span class="source-badge ${sourceClass}">
                    ${escapeHtml(s.name)}
                    <span class="session-count">(${s.sessionCount})</span>
                </span>`;
            }).join('');
        }

        async function loadProjects() {
            const container = document.getElementById('projects-list');
            const countBadge = document.getElementById('project-count');
            try {
                const res = await fetch(`${API_BASE}/api/v1/projects`);
                const data = await res.json();

                if (!data.projects || data.projects.length === 0) {
                    container.innerHTML = `<div class="empty-state">${t('no-projects')}</div>`;
                    countBadge.textContent = '0';
                    return;
                }

                // Filter by visible sources
                const filtered = data.projects.filter(p => visibleSources.has(p.source));

                // Aggregate projects by path
                const projectMap = new Map();
                for (const p of filtered) {
                    const existing = projectMap.get(p.path);
                    if (existing) {
                        // Add source info
                        existing.sources.push({
                            name: p.source,
                            sessionCount: p.session_count || 0
                        });
                        existing.totalSessions += p.session_count || 0;
                        // Use most recent modified_at
                        if (p.modified_at) {
                            const pTime = new Date(p.modified_at).getTime();
                            const existingTime = existing.modified_at ? new Date(existing.modified_at).getTime() : 0;
                            if (pTime > existingTime) {
                                existing.modified_at = p.modified_at;
                            }
                        }
                    } else {
                        projectMap.set(p.path, {
                            path: p.path,
                            name: p.name,
                            pathExists: p.path_exists,
                            sources: [{
                                name: p.source,
                                sessionCount: p.session_count || 0
                            }],
                            totalSessions: p.session_count || 0,
                            modified_at: p.modified_at
                        });
                    }
                }

                const aggregated = Array.from(projectMap.values());
                countBadge.textContent = aggregated.length;

                // Sort by modified_at desc (newest first), nulls last
                const sorted = aggregated.sort((a, b) => {
                    const aTime = a.modified_at ? new Date(a.modified_at).getTime() : 0;
                    const bTime = b.modified_at ? new Date(b.modified_at).getTime() : 0;
                    return bTime - aTime;
                });

                if (sorted.length === 0) {
                    container.innerHTML = `<div class="empty-state">${t('no-visible-projects')}</div>`;
                    return;
                }

                // Detect home directory for dimming
                const homeDir = detectHomeDir(sorted);

                container.innerHTML = sorted.map(p => `
                    <div class="project-item${p.pathExists ? '' : ' path-missing'}">
                        <div class="project-info">
                            <div class="project-path">${!p.pathExists ? `<span class="path-missing-icon" title="${t('path-missing')}">üö´</span> ` : ''}${formatPathWithDim(p.path, homeDir)}</div>
                            <div class="source-row">
                                <div class="source-badges">
                                    ${renderSourceBadges(p.sources)}
                                </div>
                                <span class="total-sessions">${p.totalSessions} ${p.totalSessions === 1 ? t('session') : t('sessions')}</span>
                            </div>
                            ${p.modified_at ? `<div class="project-meta"><span>${formatDate(p.modified_at)}</span></div>` : ''}
                        </div>
                        <div class="project-actions">
                            <button class="copy-path-btn" onclick="event.stopPropagation(); copyPath('${escapeHtml(p.path)}', this)" title="${t('click-to-copy')}">üìã</button>
                            ${renderOpenInDropdown(p.path)}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = `<div class="error">${t('error')}: ${escapeHtml(e.message)}</div>`;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function truncatePath(path) {
            if (path.length <= 30) return path;
            return '~' + path.slice(-29);
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return t('today');
            if (diffDays === 1) return t('yesterday');
            if (diffDays < 7) return t('days-ago', { n: diffDays });
            return date.toLocaleDateString();
        }

        function copyPath(path, btn) {
            navigator.clipboard.writeText(path).then(() => {
                if (btn) {
                    btn.textContent = '‚úì';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = 'üìã';
                        btn.classList.remove('copied');
                    }, 1500);
                }
            }).catch(() => { });
        }

        function toggleSourceVisibility(sourceName) {
            const eye = document.querySelector(`.source-visibility[data-source="${sourceName}"]`);
            if (visibleSources.has(sourceName)) {
                visibleSources.delete(sourceName);
                eye.classList.add('hidden');
                eye.textContent = 'üôà';
            } else {
                visibleSources.add(sourceName);
                eye.classList.remove('hidden');
                eye.textContent = 'üëÅÔ∏è';
            }
            loadProjects();
        }

        // ===== Theme Toggle =====
        function getPreferredTheme() {
            const stored = localStorage.getItem('theme');
            if (stored) return stored;
            return window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
        }

        function setTheme(theme) {
            document.body.classList.toggle('light-mode', theme === 'light');
            const icon = document.querySelector('.theme-icon');
            if (icon) {
                icon.textContent = theme === 'light' ? '‚òÄÔ∏è' : 'üåô';
            }
            localStorage.setItem('theme', theme);
        }

        function toggleTheme() {
            const isLight = document.body.classList.contains('light-mode');
            setTheme(isLight ? 'dark' : 'light');
        }

        // Initialize theme
        setTheme(getPreferredTheme());

        // ===== Connection Status =====
        let pingInterval;
        const PING_INTERVAL_MS = 10000; // 10 seconds

        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connection-status');
            const textEl = statusEl.querySelector('.status-text');

            statusEl.classList.remove('connected', 'disconnected', 'checking');
            statusEl.classList.add(status);
            textEl.textContent = text;
        }

        async function pingServer() {
            updateConnectionStatus('checking', t('checking') || 'Checking...');

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const res = await fetch(`${API_BASE}/api/v1/sources`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                if (res.ok) {
                    updateConnectionStatus('connected', t('connected') || 'Connected');
                } else {
                    updateConnectionStatus('disconnected', t('disconnected') || 'Disconnected');
                }
            } catch (e) {
                updateConnectionStatus('disconnected', t('disconnected') || 'Disconnected');
            }
        }

        function startPingInterval() {
            pingServer(); // Initial ping
            pingInterval = setInterval(pingServer, PING_INTERVAL_MS);
        }

        function stopPingInterval() {
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
        }

        // Start pinging when page loads
        startPingInterval();

        // Pause pinging when page is hidden to save resources
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopPingInterval();
            } else {
                startPingInterval();
                pingServer(); // Immediate check when becoming visible
            }
        });

        // Load all data
        loadSources();
        loadThemes();
        loadApps().then(() => loadProjects()); // Load projects after apps are available
    </script>
</body>

</html>
